# 离线分析任务说明文档

## 📋 概述

`OfflineJob.scala` 是短视频推荐系统的离线统计分析任务，负责从 HDFS 读取用户行为日志，进行统计分析，并将结果写入 MySQL。

## 🎯 主要功能

### 1. 热门视频计算
- **数据源**: HDFS 行为日志 (`/short-video/behavior/logs/*/*.json`)
- **算法**: 基于行为权重计算热门分数
  - 播放 (play/1) = 3.0 分
  - 点赞 (like/2) = 5.0 分
  - 收藏 (collect/3) = 4.0 分
  - 评论 (comment/4) = 4.0 分
- **输出**: 更新 `video_info` 表的 `is_hot` 字段（Top 100）

### 2. 每日核心指标统计
- **DAU** (日活用户数)
- **总互动量** (所有行为总数)
- **播放次数**
- **点赞次数**
- **收藏次数**
- **活跃视频数**
- **输出**: 写入 `sys_statistics_daily` 表

## 🔧 技术实现

### HDFS 路径支持
- **日期分区格式**: `hdfs://localhost:9000/short-video/behavior/logs/2025-01-20/*.json`
- **通配符格式**: `hdfs://localhost:9000/short-video/behavior/logs/*/*.json` (所有历史数据)
- **命令行参数**: 支持通过参数指定自定义路径

### 字段映射兼容
- **视频ID**: 支持 `videoId` 和 `mid` 两种字段名
- **用户ID**: `userId`
- **行为类型**: 支持字符串格式 (`"play"`, `"like"`) 和整数格式 (`1`, `2`, `3`, `4`)
- **行为时间**: 支持 `behaviorTime` 和 `createDate` 两种字段名

### MySQL 写入
- **数据库**: `short_video_platform`
- **表1**: `video_info` - 更新 `is_hot` 字段
- **表2**: `sys_statistics_daily` - 写入每日统计指标

## 📝 使用方法

### 1. 基本用法（统计今天的数据）

```bash
spark-submit \
  --class com.shortvideo.recommendation.offline.job.OfflineJob \
  --master local[*] \
  bigdata-engine/target/spark-example-1.0-jar-with-dependencies.jar
```

### 2. 指定统计日期

```bash
spark-submit \
  --class com.shortvideo.recommendation.offline.job.OfflineJob \
  --master local[*] \
  bigdata-engine/target/spark-example-1.0-jar-with-dependencies.jar \
  2025-01-20
```

### 3. 指定 HDFS 路径

```bash
spark-submit \
  --class com.shortvideo.recommendation.offline.job.OfflineJob \
  --master local[*] \
  bigdata-engine/target/spark-example-1.0-jar-with-dependencies.jar \
  2025-01-20 \
  hdfs://localhost:9000/short-video/behavior/logs/*/*.json
```

## 📊 输出示例

```
================================================================================
短视频推荐系统 - 离线统计分析任务
================================================================================
[INFO] 统计日期: 2025-01-20
[INFO] HDFS 输入路径: hdfs://localhost:9000/short-video/behavior/logs/2025-01-20/*.json
[INFO] 开始读取 HDFS 日志数据...
[INFO] 读取到原始日志记录数: 15234
[INFO] 开始计算热门视频...
[INFO] 计算出热门视频数: 100
[INFO] 已重置 100 个视频的热门标志
[INFO] 已更新 100 个视频为热门
[SUCCESS] 热门视频列表已更新到 MySQL，数量: 100
[INFO] 开始统计每日核心指标...
[INFO] 统计结果:
  - DAU (日活用户): 1250
  - 总互动量: 15234
  - 播放次数: 12000
  - 点赞次数: 1500
  - 收藏次数: 500
  - 活跃视频数: 850
[INFO] 已写入 6 条统计指标到 sys_statistics_daily
[SUCCESS] 每日统计已写入 MySQL
================================================================================
[SUCCESS] 离线统计分析任务执行完成
================================================================================
```

## 🔍 数据验证

### 1. 验证热门视频

```sql
-- 查看热门视频列表
SELECT id, title, is_hot, view_count, like_count 
FROM video_info 
WHERE is_hot = 1 
ORDER BY view_count DESC 
LIMIT 20;
```

### 2. 验证每日统计

```sql
-- 查看今日统计
SELECT * 
FROM sys_statistics_daily 
WHERE stat_date = CURDATE()
ORDER BY metric_name;

-- 查看最近7天的 DAU 趋势
SELECT stat_date, metric_value as dau
FROM sys_statistics_daily 
WHERE metric_name = 'dau' 
  AND stat_date >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
ORDER BY stat_date;
```

## ⚙️ 配置说明

### MySQL 连接配置

```scala
private val JDBC_URL = "jdbc:mysql://localhost:3306/short_video_platform?..."
private val JDBC_USER = "root"
private val JDBC_PASSWORD = "123456"  // 请根据实际环境修改
```

### Spark 配置

```scala
.config("spark.sql.shuffle.partitions", "100")
.config("spark.sql.adaptive.enabled", "true")
```

## 🔄 与 ALS 训练的关系

离线分析任务通常与 ALS 训练任务一起执行：

1. **OfflineJob**: 统计热门视频和每日指标（快速任务，几分钟完成）
2. **ALSTrainer**: 训练推荐模型并生成推荐列表（耗时任务，可能需要30分钟+）

执行顺序建议：
```bash
# 1. 先执行离线统计（快速）
spark-submit ... OfflineJob

# 2. 再执行 ALS 训练（耗时）
spark-submit ... ALSTrainer
```

## 📌 注意事项

1. **数据库密码**: 确保 `JDBC_PASSWORD` 与实际 MySQL 密码一致
2. **HDFS 路径**: 确保 HDFS 服务正常运行，且路径存在数据文件
3. **日期格式**: 命令行参数日期格式必须为 `yyyy-MM-dd`
4. **表结构**: 确保 `video_info` 和 `sys_statistics_daily` 表已创建
5. **字段兼容**: 代码已兼容多种字段名格式，但建议统一使用标准格式

## 🐛 常见问题

### Q1: 读取不到 HDFS 数据
**A**: 检查 HDFS 路径是否正确，使用 `hadoop fs -ls` 验证路径是否存在

### Q2: MySQL 连接失败
**A**: 检查数据库地址、用户名、密码是否正确，确保 MySQL 服务正在运行

### Q3: 热门视频数量不足 100
**A**: 这是正常现象，如果数据量较少，会返回实际计算出的热门视频数量

### Q4: 统计指标为 0
**A**: 检查 HDFS 日志文件格式是否正确，确保字段名匹配（支持 videoId/mid, behaviorType 等）

## 📚 相关文档

- [ALS 修复说明](./ALS修复说明.md)
- [技术方案文档](../../../短视频推荐系统技术方案.md)
- [数据库结构](../../backend-server/src/main/resources/database.sql)
