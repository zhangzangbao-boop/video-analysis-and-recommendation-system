# 视频数据导入完整流程指南

## 📋 流程概览

```
JSON文件 → [选择方案] → 数据库
           ├─ 方案A: 直接使用Pexels URL（快速，但依赖外部服务）
           └─ 方案B: 上传到腾讯云COS（推荐，稳定可靠）
```

## 🎯 方案选择

### 方案A: 直接使用Pexels URL（快速测试）

**适用场景**: 
- 快速测试系统功能
- 不需要长期存储
- 可以接受依赖外部服务

**优点**: 
- 快速，无需下载上传
- 节省存储空间和流量费用

**缺点**: 
- 依赖Pexels服务稳定性
- 可能面临版权问题
- 无法控制视频可用性

**使用方法**:
```bash
# 1. 生成SQL（直接使用Pexels URL）
python backend-server/scripts/import_videos_from_json.py "f:/视频json文件/视频json文件/*.json" --user-id 10000 --status 1 --use-external-url --output videos_with_pexels_url.sql

# 2. 执行SQL导入
mysql -u root -p short_video_platform < videos_with_pexels_url.sql
```

### 方案B: 上传到腾讯云COS（生产环境推荐）

**适用场景**: 
- 生产环境部署
- 需要稳定可靠的视频服务
- 需要控制视频存储和访问

**优点**: 
- 完全控制视频存储
- 稳定可靠，不依赖外部服务
- 更好的性能和CDN加速

**缺点**: 
- 需要下载和上传时间
- 产生存储和流量费用
- 需要配置腾讯云COS

**使用方法**:
```bash
# 1. 下载并上传视频到COS
python backend-server/scripts/upload_videos_to_cos.py "f:/视频json文件/视频json文件/*.json"

# 2. 更新数据库URL
mysql -u root -p short_video_platform < uploaded_videos_update.sql

# 3. （可选）如果视频不存在，先导入基本信息
python backend-server/scripts/import_videos_from_json.py "f:/视频json文件/视频json文件/*.json" --user-id 10000 --status 1 --output videos_basic_info.sql
mysql -u root -p short_video_platform < videos_basic_info.sql
```

## 📝 详细步骤

### 步骤1: 准备JSON文件

确保JSON文件格式正确：
```json
[
  {
    "id": 5794445,
    "title": "food创意瞬间 · 33s · 第1段",
    "description": "精彩视频",
    "videoUrl": "https://videos.pexels.com/video-files/...",
    "coverUrl": "https://images.pexels.com/videos/...",
    "duration": 33,
    "tags": "舞蹈,潮流,运动",
    "source": "pexels"
  }
]
```

### 步骤2: 选择导入方案

#### 如果选择方案A（直接使用Pexels URL）

```bash
# 生成SQL
python backend-server/scripts/import_videos_from_json.py \
  "f:/视频json文件/视频json文件/*.json" \
  --user-id 10000 \
  --status 1 \
  --use-external-url \
  --output videos_import.sql

# 执行SQL
mysql -u root -p short_video_platform < videos_import.sql
```

#### 如果选择方案B（上传到COS）

```bash
# 1. 安装依赖
pip install cos-python-sdk-v5 requests

# 2. 检查配置
# 确保 backend-server/src/main/resources/application.yml 中配置了腾讯云COS

# 3. 上传视频到COS
python backend-server/scripts/upload_videos_to_cos.py \
  "f:/视频json文件/视频json文件/*.json" \
  --output uploaded_videos.sql

# 4. 执行SQL更新URL
mysql -u root -p short_video_platform < uploaded_videos.sql
```

### 步骤3: 验证数据

```sql
-- 查看导入的视频总数
SELECT COUNT(*) as total FROM video_info;

-- 查看视频URL（确认是COS URL还是Pexels URL）
SELECT id, title, 
       CASE 
         WHEN video_url LIKE '%cos.%' THEN 'COS'
         WHEN video_url LIKE '%pexels%' THEN 'Pexels'
         ELSE '其他'
       END as source,
       video_url
FROM video_info 
LIMIT 10;

-- 按分类统计
SELECT 
    c.name as category,
    COUNT(v.id) as count
FROM video_info v
LEFT JOIN video_category c ON v.category_id = c.id
GROUP BY c.name;
```

## ⚙️ 配置说明

### 腾讯云COS配置（方案B需要）

在 `backend-server/src/main/resources/application.yml` 中配置：

```yaml
tencent:
  cos:
    secret-id: 你的SecretId          # 从腾讯云控制台获取
    secret-key: 你的SecretKey        # 从腾讯云控制台获取
    region: ap-guangzhou             # 存储桶地域
    bucket-name: 你的存储桶名称      # 存储桶名称
    domain: https://你的存储桶域名    # 存储桶访问域名
    video-folder: video/short_video/ # 视频存储文件夹
    cover-folder: video/cover/       # 封面存储文件夹
```

### 数据库配置

确保数据库已创建并初始化：
```bash
# 执行数据库初始化脚本
mysql -u root -p < backend-server/src/main/resources/database.sql
```

## 🔍 常见问题

### Q1: 如何知道视频是否已上传到COS？

**A**: 执行以下SQL查询：
```sql
SELECT id, title, 
       CASE 
         WHEN video_url LIKE '%cos.%' THEN '已上传到COS'
         WHEN video_url LIKE '%pexels%' THEN '使用Pexels URL'
         ELSE '未知来源'
       END as status
FROM video_info;
```

### Q2: 上传到COS需要多长时间？

**A**: 取决于：
- 视频文件大小
- 网络速度
- 视频数量

通常每个视频需要1-5分钟（下载+上传）。

### Q3: 可以直接使用Pexels URL吗？

**A**: 可以，但需要注意：
- 依赖Pexels服务稳定性
- 可能面临版权问题
- 建议生产环境使用COS

### Q4: 上传失败怎么办？

**A**: 
1. 检查网络连接
2. 检查COS配置是否正确
3. 检查存储桶权限
4. 查看错误日志

### Q5: 如何批量更新已导入的视频URL？

**A**: 如果已经导入了Pexels URL，可以：
```bash
# 1. 从数据库导出视频ID和原URL
mysql -u root -p short_video_platform -e "
  SELECT id, video_url, cover_url 
  FROM video_info 
  WHERE video_url LIKE '%pexels%'
" > videos_to_upload.txt

# 2. 根据导出的数据，使用upload_videos_to_cos.py上传
# （需要修改脚本支持从数据库读取）

# 或者手动更新：
# 1. 使用upload_videos_to_cos.py上传新视频
# 2. 执行生成的SQL更新URL
```

## 📚 相关文档

- [视频导入工具说明](./README_视频导入.md)
- [COS上传工具说明](./README_COS上传.md)
- [腾讯云COS配置说明](../../腾讯云COS配置说明.md)
- [快速使用指南](./快速使用指南.md)

## 🎯 推荐流程

**开发/测试环境**: 使用方案A（快速）
```bash
python backend-server/scripts/import_videos_from_json.py "*.json" --use-external-url --output test_videos.sql
mysql -u root -p short_video_platform < test_videos.sql
```

**生产环境**: 使用方案B（稳定）
```bash
python backend-server/scripts/upload_videos_to_cos.py "*.json"
mysql -u root -p short_video_platform < uploaded_videos_update.sql
```
